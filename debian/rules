#!/usr/bin/make -f

# 1. Global Exports (Inherited by all sub-shells)
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export PKG_CONFIG_PATH := $(CURDIR)/src/wk2gtkpdf:$(PKG_CONFIG_PATH)
export LD_LIBRARY_PATH := $(CURDIR)/src/wk2gtkpdf:$(LD_LIBRARY_PATH)

# 2. Dynamic Version Detection
PODOFO_VERSION := $(shell pkg-config --modversion libpodofo 2>/dev/null || echo 0)
IS_010 := $(shell echo "$(PODOFO_VERSION)" | grep -q '^0.10' && echo yes || echo no)

ifeq ($(IS_010),yes)
    export DEB_CXXFLAGS_MAINT_APPEND = -DPODOFO_010
endif

# 3. Main Boilerplate
%:
	dh $@

# 4. Custom Logic
override_dh_makeshlibs:
	dh_makeshlibs -V

override_dh_auto_build:
	# Build Library first so its .pc and .so are ready for the CLI
	$(MAKE) -C src/wk2gtkpdf
	# Build CLI using the local library paths
	$(MAKE) -C src/cli \
		USER_INCDIR="-I$(CURDIR)/src/wk2gtkpdf" \
		USER_LIBDIR="-L$(CURDIR)/src/wk2gtkpdf"

override_dh_auto_install:
	$(MAKE) -C src/wk2gtkpdf install DESTDIR=$(CURDIR)/debian/tmp
	$(MAKE) -C src/cli install DESTDIR=$(CURDIR)/debian/tmp
